
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.11">
    
    
      
        <title>MAP Trust Channel — Developer Design Spec (Fully Expanded) - MAP Dynamic Adaptive Holon Navigator Development</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="cyan">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#map-trust-channel-developer-design-spec-fully-expanded" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="MAP Dynamic Adaptive Holon Navigator Development" class="md-header__button md-logo" aria-label="MAP Dynamic Adaptive Holon Navigator Development" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            MAP Dynamic Adaptive Holon Navigator Development
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              MAP Trust Channel — Developer Design Spec (Fully Expanded)
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="cyan"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="cyan"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="MAP Dynamic Adaptive Holon Navigator Development" class="md-nav__button md-logo" aria-label="MAP Dynamic Adaptive Holon Navigator Development" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    MAP Dynamic Adaptive Holon Navigator Development
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Dynamic Adaptive Holon Navigator (DAHN)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Dynamic Adaptive Holon Navigator (DAHN)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dahn/sea-manifesto/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Semantic Experience Architecture (SEA) Manifesto
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dahn/dahn-project-brief/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DAHN Project Brief
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dahn/dynamic-experience-composition/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Dynamic Experience Composition
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dahn/dahn-implementation-plan/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DAHN Implementation Plan
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Visualizer Developers
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Shared Concepts
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../shared/glossary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Glossary
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0-purpose-scope" class="md-nav__link">
    <span class="md-ellipsis">
      0. Purpose &amp; Scope
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-deployment-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      1. Deployment Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Deployment Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-system-topology-overview" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 System Topology Overview
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-trust-channel-cross-section" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 Trust Channel Cross-Section
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-implementation-layers-and-protocol-adapters" class="md-nav__link">
    <span class="md-ellipsis">
      1.3 Implementation Layers and Protocol Adapters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-core-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      2. Core Concepts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Core Concepts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#20-narrative-overview" class="md-nav__link">
    <span class="md-ellipsis">
      2.0 Narrative Overview
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.0 Narrative Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#narrative-rule" class="md-nav__link">
    <span class="md-ellipsis">
      Narrative Rule
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#21-dance-capsule" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 Dance Capsule
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-agreement-and-protocolsuite" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 Agreement and ProtocolSuite
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-protocol-negotiation" class="md-nav__link">
    <span class="md-ellipsis">
      2.3 Protocol Negotiation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-session-state-envelope" class="md-nav__link">
    <span class="md-ellipsis">
      2.4 Session State Envelope
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-roles-traits-and-naming-narrative" class="md-nav__link">
    <span class="md-ellipsis">
      2.4 Roles, Traits, and Naming Narrative
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.4 Roles, Traits, and Naming Narrative">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#narrative-rule_1" class="md-nav__link">
    <span class="md-ellipsis">
      Narrative Rule
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-envelope-layer-reference-expanded" class="md-nav__link">
    <span class="md-ellipsis">
      3. Envelope Layer Reference (Expanded)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Envelope Layer Reference (Expanded)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-transport-envelope" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 Transport Envelope
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.1 Transport Envelope">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conceptual-purpose" class="md-nav__link">
    <span class="md-ellipsis">
      Conceptual Purpose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#holon-type-and-relationships" class="md-nav__link">
    <span class="md-ellipsis">
      Holon Type and Relationships
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-data-fields" class="md-nav__link">
    <span class="md-ellipsis">
      Key Data Fields
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#processing-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Processing Steps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#expected-outcome" class="md-nav__link">
    <span class="md-ellipsis">
      Expected Outcome
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#developer-guidance" class="md-nav__link">
    <span class="md-ellipsis">
      Developer Guidance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-authentication-envelope-authn" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 Authentication Envelope (AuthN)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2 Authentication Envelope (AuthN)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conceptual-purpose_1" class="md-nav__link">
    <span class="md-ellipsis">
      Conceptual Purpose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#holon-type-and-relationships_1" class="md-nav__link">
    <span class="md-ellipsis">
      Holon Type and Relationships
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-data-fields_1" class="md-nav__link">
    <span class="md-ellipsis">
      Key Data Fields
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#processing-steps_1" class="md-nav__link">
    <span class="md-ellipsis">
      Processing Steps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#expected-outcome_1" class="md-nav__link">
    <span class="md-ellipsis">
      Expected Outcome
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#developer-guidance_1" class="md-nav__link">
    <span class="md-ellipsis">
      Developer Guidance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-cryptography-envelope-crypto" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 Cryptography Envelope (Crypto)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.3 Cryptography Envelope (Crypto)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conceptual-purpose_2" class="md-nav__link">
    <span class="md-ellipsis">
      Conceptual Purpose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#holon-type-and-relationships_2" class="md-nav__link">
    <span class="md-ellipsis">
      Holon Type and Relationships
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-data-fields_2" class="md-nav__link">
    <span class="md-ellipsis">
      Key Data Fields
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#processing-steps_2" class="md-nav__link">
    <span class="md-ellipsis">
      Processing Steps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#expected-outcome_2" class="md-nav__link">
    <span class="md-ellipsis">
      Expected Outcome
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#developer-guidance_2" class="md-nav__link">
    <span class="md-ellipsis">
      Developer Guidance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-authorization-envelope-authz" class="md-nav__link">
    <span class="md-ellipsis">
      3.4 Authorization Envelope (AuthZ)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.4 Authorization Envelope (AuthZ)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conceptual-purpose_3" class="md-nav__link">
    <span class="md-ellipsis">
      Conceptual Purpose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#holon-type-and-relationships_3" class="md-nav__link">
    <span class="md-ellipsis">
      Holon Type and Relationships
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-data-fields_3" class="md-nav__link">
    <span class="md-ellipsis">
      Key Data Fields
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#processing-steps_3" class="md-nav__link">
    <span class="md-ellipsis">
      Processing Steps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#expected-outcome_3" class="md-nav__link">
    <span class="md-ellipsis">
      Expected Outcome
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#developer-guidance_3" class="md-nav__link">
    <span class="md-ellipsis">
      Developer Guidance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35-dispatch-envelope" class="md-nav__link">
    <span class="md-ellipsis">
      3.5 Dispatch Envelope
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.5 Dispatch Envelope">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conceptual-purpose_4" class="md-nav__link">
    <span class="md-ellipsis">
      Conceptual Purpose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#holon-type-and-relationships_4" class="md-nav__link">
    <span class="md-ellipsis">
      Holon Type and Relationships
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-data-fields_4" class="md-nav__link">
    <span class="md-ellipsis">
      Key Data Fields
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#processing-steps_4" class="md-nav__link">
    <span class="md-ellipsis">
      Processing Steps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#expected-outcome_4" class="md-nav__link">
    <span class="md-ellipsis">
      Expected Outcome
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#developer-guidance_4" class="md-nav__link">
    <span class="md-ellipsis">
      Developer Guidance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#36-payload-envelope" class="md-nav__link">
    <span class="md-ellipsis">
      3.6 Payload Envelope
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.6 Payload Envelope">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conceptual-purpose_5" class="md-nav__link">
    <span class="md-ellipsis">
      Conceptual Purpose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#holon-type-and-relationships_5" class="md-nav__link">
    <span class="md-ellipsis">
      Holon Type and Relationships
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-data-fields_5" class="md-nav__link">
    <span class="md-ellipsis">
      Key Data Fields
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#processing-steps_5" class="md-nav__link">
    <span class="md-ellipsis">
      Processing Steps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#expected-outcome_5" class="md-nav__link">
    <span class="md-ellipsis">
      Expected Outcome
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#developer-guidance_5" class="md-nav__link">
    <span class="md-ellipsis">
      Developer Guidance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#37-exfiltration-envelope-outbound" class="md-nav__link">
    <span class="md-ellipsis">
      3.7 Exfiltration Envelope (Outbound)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.7 Exfiltration Envelope (Outbound)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conceptual-purpose_6" class="md-nav__link">
    <span class="md-ellipsis">
      Conceptual Purpose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#holon-type-and-relationships_6" class="md-nav__link">
    <span class="md-ellipsis">
      Holon Type and Relationships
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-data-fields_6" class="md-nav__link">
    <span class="md-ellipsis">
      Key Data Fields
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#processing-steps_6" class="md-nav__link">
    <span class="md-ellipsis">
      Processing Steps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#expected-outcome_6" class="md-nav__link">
    <span class="md-ellipsis">
      Expected Outcome
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#developer-guidance_6" class="md-nav__link">
    <span class="md-ellipsis">
      Developer Guidance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#38-unlock-envelope-optional" class="md-nav__link">
    <span class="md-ellipsis">
      3.8 Unlock Envelope (Optional)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.8 Unlock Envelope (Optional)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conceptual-purpose_7" class="md-nav__link">
    <span class="md-ellipsis">
      Conceptual Purpose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#holon-type-and-relationships_7" class="md-nav__link">
    <span class="md-ellipsis">
      Holon Type and Relationships
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-data-fields_7" class="md-nav__link">
    <span class="md-ellipsis">
      Key Data Fields
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#processing-steps_7" class="md-nav__link">
    <span class="md-ellipsis">
      Processing Steps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#expected-outcome_7" class="md-nav__link">
    <span class="md-ellipsis">
      Expected Outcome
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#developer-guidance_7" class="md-nav__link">
    <span class="md-ellipsis">
      Developer Guidance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#39-sessionstate-envelope-optional" class="md-nav__link">
    <span class="md-ellipsis">
      3.9 SessionState Envelope (Optional)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.9 SessionState Envelope (Optional)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conceptual-purpose_8" class="md-nav__link">
    <span class="md-ellipsis">
      Conceptual Purpose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#holon-type-and-relationships_8" class="md-nav__link">
    <span class="md-ellipsis">
      Holon Type and Relationships
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-data-fields_8" class="md-nav__link">
    <span class="md-ellipsis">
      Key Data Fields
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#processing-steps_8" class="md-nav__link">
    <span class="md-ellipsis">
      Processing Steps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#expected-outcome_8" class="md-nav__link">
    <span class="md-ellipsis">
      Expected Outcome
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#developer-guidance_8" class="md-nav__link">
    <span class="md-ellipsis">
      Developer Guidance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-lifecycle-overview" class="md-nav__link">
    <span class="md-ellipsis">
      4. Lifecycle Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      5. Error Handling
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-implementation-notes" class="md-nav__link">
    <span class="md-ellipsis">
      6. Implementation Notes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Implementation Notes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-packaging-and-dependency-isolation" class="md-nav__link">
    <span class="md-ellipsis">
      6.1 Packaging and Dependency Isolation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-summary" class="md-nav__link">
    <span class="md-ellipsis">
      7. Summary
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Summary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#appendix-a-unified-ingress-egress-summary" class="md-nav__link">
    <span class="md-ellipsis">
      Appendix A — Unified Ingress / Egress Summary
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="map-trust-channel-developer-design-spec-fully-expanded">MAP Trust Channel — Developer Design Spec (Fully Expanded)<a class="headerlink" href="#map-trust-channel-developer-design-spec-fully-expanded" title="Permanent link">&para;</a></h1>
<h2 id="0-purpose-scope">0. Purpose &amp; Scope<a class="headerlink" href="#0-purpose-scope" title="Permanent link">&para;</a></h2>
<p>The <strong>Trust Channel</strong> is the MAP core service that encapsulates, transports, and validates <strong>Dance Capsules</strong> whenever an interaction crosses a <strong>membrane boundary</strong> between Spaces. It enforces Agreement-governed security, privacy, and protocol consistency through layered envelopes that correspond to membrane validation gates.</p>
<p>Trust Channels:</p>
<ul>
<li>Exist <strong>only</strong> in the Rust runtime; the TypeScript SDK never hosts a Trust Channel.</li>
<li>Are always governed by an <strong>Agreement</strong>, which defines envelope sequencing, crypto and policy parameters.</li>
<li>Dynamically select compatible <strong>ProtocolSuites</strong> through <strong>Protocol Negotiation</strong> during capsule formation.</li>
<li>Trigger the transport and validation mechanism for all cross-Space Dances.</li>
</ul>
<p>The TypeScript↔Rust interface inside a single Tauri process is <em>not</em> a membrane boundary and therefore bypasses Trust Channel logic.</p>
<hr />
<h2 id="1-deployment-architecture">1. Deployment Architecture<a class="headerlink" href="#1-deployment-architecture" title="Permanent link">&para;</a></h2>
<h3 id="11-system-topology-overview">1.1 System Topology Overview<a class="headerlink" href="#11-system-topology-overview" title="Permanent link">&para;</a></h3>
<p>Each <strong>Agent</strong> in MAP operates within an <strong>Agreement Space</strong>—a space containing all (and only) those Agents that share at least one Agreement. Agents are depicted as spheres connected by a <strong>mycelial web</strong> of Trust Channels representing the live peer-to-peer fabric.</p>
<ul>
<li><strong>Source Container:</strong> Rust runtime of the sending Agent (Space A).</li>
<li><strong>Destination Container:</strong> Rust runtime of the receiving Agent (Space B).</li>
<li><strong>Trust Channel:</strong> logical and cryptographic conduit linking both membranes.</li>
<li><strong>Transport Protocol:</strong> the routing mechanism defined by the Agreement (e.g., DHT gossip, relay, or direct peer link).</li>
</ul>
<p>When a <strong>DanceRequest</strong> leaves an Agent’s pore, it travels through the Trust Channel across the mycelial web, wrapped in layers of envelopes that perform sequential validation.<br />
At the receiving pore, the Trust Channel unwraps these envelopes inward, validating routing, signature, encryption, authorization, and dispatch.<br />
A <strong>DanceResponse</strong> is then re-encapsulated with outbound envelopes in reverse order and sent back through the same path.</p>
<h3 id="12-trust-channel-cross-section">1.2 Trust Channel Cross-Section<a class="headerlink" href="#12-trust-channel-cross-section" title="Permanent link">&para;</a></h3>
<p>Each Trust Channel is visualized as a <strong>funnel</strong> through the agent’s membrane.<br />
Envelopes are represented as <strong>gates</strong>, initially closed.<br />
As validation succeeds layer by layer, each gate opens and the remaining inner capsule drops through to the next gate until only the inner <strong>Dance</strong> remains.<br />
Outbound responses travel upward through the same funnel, having their envelopes reapplied and gates resealed.</p>
<h3 id="13-implementation-layers-and-protocol-adapters">1.3 Implementation Layers and Protocol Adapters<a class="headerlink" href="#13-implementation-layers-and-protocol-adapters" title="Permanent link">&para;</a></h3>
<p>Every membrane-crossing exchange follows the same structural flow:</p>
<div class="highlight"><pre><span></span><code>┌───────────────────────────────────────────────┐
│  Protocol Adapters (transport-specific)       │
│  ├─ Holochain extern adapter                  │
│  ├─ Direct Wire adapter (future)              │
│  ├─ Relay / HTTP adapter (future)             │
└───────────────┬───────────────────────────────┘
                │  (Capsule ingress / egress)
                ▼
         CapsuleDancer::dance_capsule()
                │
                ▼
           TrustChannel
      (unwrap → validate → dispatch)
                │
                ▼
             Dancer
          (executes the Dance)
                │
                ▼
           TrustChannel
      (wrap → encrypt → sign)
                │
                ▼
         CapsuleDancer::dance_capsule()
</code></pre></div>
<p><strong>Key Points</strong></p>
<ul>
<li>The <code>#[hdk_extern] fn dance_capsule</code> in the Holochain build acts as the <em>Holochain Protocol Adapter</em>—the membrane pore for that protocol.</li>
<li>All protocol adapters, present and future, delegate to the same <code>CapsuleDancer::dance_capsule</code> function.</li>
<li><code>CapsuleDancer</code> is protocol-agnostic; it receives inbound capsules and hands them to the <code>TrustChannel</code> for envelope handling and dispatch.</li>
<li><code>TrustChannel</code> performs the actual wrap/unwrap sequence, policy enforcement, suite negotiation, and orchestration of requests and replies.</li>
<li><code>Dancer</code> executes the validated <code>Dance</code> inside the local space after all Trust Channel gates have cleared.</li>
</ul>
<p>This layering produces a <strong>unified ingress/egress interface</strong> shared across all transports.<br />
It ensures that Trust Channel logic, envelope validation, and Agreement-based security are applied consistently—no matter which protocol conveys the capsule.</p>
<hr />
<h2 id="2-core-concepts">2. Core Concepts<a class="headerlink" href="#2-core-concepts" title="Permanent link">&para;</a></h2>
<h3 id="20-narrative-overview">2.0 Narrative Overview<a class="headerlink" href="#20-narrative-overview" title="Permanent link">&para;</a></h3>
<p>The Trust Channel’s terminology and type system are intentionally aligned with the language of Dances.<br />
Every core trait and struct name was chosen to reflect its role in the lifecycle of a Dance and to make Trust Channel code read semantically true to its purpose.<br />
This consistency ensures that both developers and auditors can infer each component’s responsibility directly from its name.</p>
<table>
<thead>
<tr>
<th>Conceptual Role</th>
<th>Rust Type</th>
<th>Primary Verb</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Dance Initiator</strong></td>
<td><code>trait DanceInitiator</code></td>
<td><em>initiate</em></td>
<td>Begins a new Dance across a membrane. The caller works purely with Dances, not Capsules.</td>
</tr>
<tr>
<td><strong>Trust Channel</strong></td>
<td><code>struct TrustChannel</code></td>
<td><em>convey</em></td>
<td>Implements <code>DanceInitiator</code> and <code>CapsuleDancer</code>; orchestrates the wrapping, validation, and transport of Capsules.</td>
</tr>
<tr>
<td><strong>Capsule Dancer</strong></td>
<td><code>trait CapsuleDancer</code></td>
<td><em>dance</em></td>
<td>Protocol-agnostic ingress/egress interface invoked by all protocol adapters (Holochain, Wire, HTTP, etc.).</td>
</tr>
<tr>
<td><strong>Dancer</strong></td>
<td><code>trait Dancer</code></td>
<td><em>dance</em></td>
<td>Executes the validated <code>Dance</code> inside the local space after all Trust Channel gates have cleared.</td>
</tr>
</tbody>
</table>
<h4 id="narrative-rule">Narrative Rule<a class="headerlink" href="#narrative-rule" title="Permanent link">&para;</a></h4>
<blockquote>
<p><em>Initiators initiate dances;<br />
Trust Channels convey dances via capsules;<br />
Capsule Dancers dance capsules;<br />
and Dancers dance dances.</em></p>
</blockquote>
<p>This rule serves as the linguistic foundation of the Trust Channel’s architecture.<br />
The following sections describe how Dances are encapsulated, validated, and conveyed through the membrane layers defined by their governing <strong>Agreements</strong> and <strong>ProtocolSuites</strong>.</p>
<h3 id="21-dance-capsule">2.1 Dance Capsule<a class="headerlink" href="#21-dance-capsule" title="Permanent link">&para;</a></h3>
<p>A <strong>Dance Capsule</strong> is a Russian doll–like structure of nested <strong>Envelopes</strong> that surround a <code>Dance</code> (request or response).<br />
Each envelope performs one membrane function: routing, authentication, encryption, authorization, state transfer, dispatch, or filtering.</p>
<p><strong>Inbound validation sequence:</strong><br />
<code>Transport → AuthN → Crypto → AuthZ → Dispatch → SessionState → Payload</code></p>
<p><strong>Outbound response sequence:</strong><br />
<code>Payload → SessionState → Exfiltration → Crypto → AuthN → Transport</code></p>
<p>For inbound capsules, each layer exposes progressively unwrapped content to the next validation phase until only the inner <strong>PayloadEnvelope</strong> remains, revealing the <code>Dance</code> to be executed.<br />
For outbound capsules, each layer successively rewraps the content, sealing the validated <code>DanceResponse</code> for return transport.</p>
<p>The <strong>SessionStateEnvelope</strong> appears immediately inside the Dispatch/Exfiltration boundary.<br />
It carries transient holon state and nursery references needed for stateless or multi-step executions, ensuring that ephemeral context can safely cross the membrane without persistent storage.</p>
<hr />
<h3 id="22-agreement-and-protocolsuite">2.2 Agreement and ProtocolSuite<a class="headerlink" href="#22-agreement-and-protocolsuite" title="Permanent link">&para;</a></h3>
<p>Each Trust Channel is governed by an <strong>Agreement</strong>, which defines the policies, cryptographic parameters, and procedural rules that bind all participants within its trust domain.<br />
An Agreement is not a design-time construct; it is a <strong>runtime artifact</strong> produced through the <strong>Promise Weave Protocol</strong>, in which participating agents exchange and mutually sign reciprocal promises.<br />
Those promises collectively determine the channel’s trust semantics, including the <strong>ProtocolSuite</strong> to be used for all subsequent capsule exchanges.</p>
<p>The resulting ProtocolSuite is <strong>pinned</strong> to the Agreement at the moment the weave completes.<br />
It defines the complete envelope composition and validation order for the channel, ensuring that all parties share a common, immutable understanding of how capsules are formed, validated, and conveyed.<br />
Once established, the suite cannot be altered dynamically — only the <strong>transport protocol</strong> that carries the capsules may vary at runtime.</p>
<p>An <strong>Agreement</strong> specifies:</p>
<ul>
<li>Its governing <strong>ProtocolSuite</strong> (defining the envelope structure and allowable transport families for this trust domain).</li>
<li>Mappings between Dances and the suite via <code>DancePolicyMap</code>.</li>
<li>Cryptographic and policy relationships (<code>AuthZPolicy</code>, <code>CryptoPolicy</code>, <code>ExfiltrationPolicy</code>, <code>StepUpPolicy</code>).</li>
</ul>
<p>A <strong>ProtocolSuite</strong> holon defines:</p>
<ul>
<li>The ordered envelope sequences for inbound and outbound directions, including whether the <strong>SessionStateEnvelope</strong> is <em>required</em> or <em>optional</em>.</li>
<li>The validator modules for each envelope kind.</li>
<li>The cryptographic, authorization, and state-transfer policies applied at each layer.</li>
<li>The set of transport protocols supported for runtime selection.</li>
</ul>
<p>Together, the Agreement and its pinned ProtocolSuite completely determine the membrane behavior for all capsule exchanges within that domain.<br />
Only the transport protocol remains subject to runtime negotiation.</p>
<hr />
<h3 id="23-protocol-negotiation">2.3 Protocol Negotiation<a class="headerlink" href="#23-protocol-negotiation" title="Permanent link">&para;</a></h3>
<p>Protocol negotiation determines which <strong>transport protocol</strong> will be used for a specific capsule exchange under an established Agreement.<br />
All higher-level parameters — envelope ordering, policies, and validation gates — are pinned by the Agreement’s ProtocolSuite and cannot vary at runtime.</p>
<p>Negotiation occurs only when sender and receiver must select among the transport mechanisms enumerated in the Agreement.<br />
This selection allows peers to adapt to transient network conditions such as reachability, latency, or relay availability without altering the trust semantics of the exchange.</p>
<p><strong>Negotiation Steps</strong></p>
<ol>
<li><strong>Proposal</strong> — The sender selects a candidate transport from the ProtocolSuite’s supported set and records it as <code>ProposesTransport</code> in the outer <code>TransportEnvelope</code>.</li>
<li><strong>Validation</strong> — The receiver confirms that the proposed transport is allowed under the Agreement and compatible with the pinned <code>ProtocolSuite</code>.</li>
<li><strong>Response</strong> — The receiver records its choice as <code>AcceptedTransport</code>, either confirming the proposal or selecting an alternative from the allowed set.</li>
<li><strong>Pinning</strong> — The capsule pins <code>PinnedAgreement → Agreement</code>, <code>PinnedSuite → ProtocolSuite</code>, and <code>NegotiatedTransport → TransportProtocol</code>.</li>
<li><strong>Verification</strong> — Upon receipt, validators confirm that the negotiated transport matches the Agreement’s definitions and that all pinned parameters remain consistent.</li>
</ol>
<p><strong>Example</strong>
<div class="highlight"><pre><span></span><code>TransportEnvelope
 ├── ForAgreement → #agr:std
 ├── PinnedSuite → #suite:std-full
 ├── ProposesTransport → DHT
 └── AcceptedTransport → Relay
</code></pre></div></p>
<p>Once transport selection is complete, the capsule exchange proceeds under the pinned <code>ProtocolSuite</code>.<br />
Envelope ordering, cryptographic policies, and validation rules remain invariant throughout the interaction, ensuring that every Trust Channel behaves consistently with the terms of its Agreement.</p>
<h3 id="24-session-state-envelope">2.4 Session State Envelope<a class="headerlink" href="#24-session-state-envelope" title="Permanent link">&para;</a></h3>
<p>The <strong>SessionStateEnvelope</strong> enables stateful workflows to operate across otherwise stateless environments.<br />
It serializes transient holons and relationship references needed to resume an in-flight Dance while preventing data persistence outside the membrane.</p>
<p><strong>Conceptual Purpose</strong>
- Provides transient continuity between asynchronous or multi-step Dances.
- Avoids leaking ephemeral data into long-lived storage.
- Ensures transient state passes through the same validation gates as other envelopes.</p>
<p><strong>Holon Type and Relationships</strong>
<div class="highlight"><pre><span></span><code>HolonType: SessionStateEnvelope
Relationships:
  Wraps → PayloadEnvelope
  CarriesState → [TransientHolonPool, NurseryRefs]
</code></pre></div></p>
<p><strong>Key Data Fields</strong>
- <code>state_hash</code>: integrity checksum of serialized transient data
- <code>state_length</code>: size of the transient payload in bytes
- <code>allowed_types</code>: whitelist of permitted transient holon types</p>
<p><strong>Processing Steps</strong>
<strong>Build</strong>
1. Serialize the transient pool and nursery references.
2. Compute and record the state hash and metadata.
3. Attach to the inner <code>PayloadEnvelope</code>.</p>
<p><strong>Validate</strong>
1. Verify hash integrity and payload size.
2. Deserialize the transient pool into local memory.
3. Enforce the <code>allowed_types</code> whitelist.</p>
<p><strong>Expected Outcome</strong>
Transient state is hydrated in the recipient’s runtime context, enabling seamless continuation of execution without permanent storage.</p>
<p><em>Current Implementation Status:</em><br />
The Session State Envelope is the only Trust Channel layer realized in the initial implementation (<strong>Issue #308</strong>).<br />
All other envelopes remain stubbed for future iterations once cross-Space communication is activated.</p>
<hr />
<h3 id="24-roles-traits-and-naming-narrative">2.4 Roles, Traits, and Naming Narrative<a class="headerlink" href="#24-roles-traits-and-naming-narrative" title="Permanent link">&para;</a></h3>
<p>MAP adopts consistent nouns and verbs so that Trust Channel code reads like the story it represents.<br />
Each trait name and its primary verb mirror the narrative logic of a Dance.</p>
<table>
<thead>
<tr>
<th>Conceptual Role</th>
<th><strong>Rust Type</strong></th>
<th><strong>Key Function(s)</strong></th>
<th><strong>Primary Verb</strong></th>
<th><strong>Operates On</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Dance Initiator</strong></td>
<td><code>trait DanceInitiator</code></td>
<td><code>async fn initiate_dance(&amp;self, context, request)</code></td>
<td><em>initiate</em></td>
<td><code>DanceRequest ↦ DanceResponse</code></td>
<td>Begins a new Dance across a membrane. The caller sees only Dances, not Capsules.</td>
</tr>
<tr>
<td><strong>Trust Channel</strong></td>
<td><code>struct TrustChannel</code> <em>(implements <code>DanceInitiator</code> and <code>CapsuleDancer</code>)</em></td>
<td><code>initiate_dance()</code> / <code>dance_capsule()</code></td>
<td><em>convey</em></td>
<td><code>Capsule</code></td>
<td>Governs envelope wrapping/unwrapping, validation, and transport orchestration.</td>
</tr>
<tr>
<td><strong>Capsule Dancer</strong></td>
<td><code>trait CapsuleDancer</code></td>
<td><code>fn dance_capsule(&amp;self, capsule)</code></td>
<td><em>dance</em></td>
<td><code>Capsule ↦ Capsule</code></td>
<td>Protocol-agnostic ingress/egress interface called by all adapters (Holochain, Wire, HTTP, etc.).</td>
</tr>
<tr>
<td><strong>Dancer</strong></td>
<td><code>trait Dancer</code></td>
<td><code>async fn dance(&amp;self, request)</code></td>
<td><em>dance</em></td>
<td>inner <code>Dance</code></td>
<td>Executes the validated Dance inside the local space once all Trust Channel gates have cleared.</td>
</tr>
</tbody>
</table>
<h4 id="narrative-rule_1">Narrative Rule<a class="headerlink" href="#narrative-rule_1" title="Permanent link">&para;</a></h4>
<blockquote>
<p><em>Initiators initiate dances;<br />
Trust Channels convey dances via capsules;<br />
Capsule Dancers dance capsules;<br />
and Dancers dance dances.</em></p>
</blockquote>
<p>These naming conventions preserve conceptual clarity, separate transport concerns from trust logic, and ensure that function names describe their precise role in the Dance lifecycle.</p>
<hr />
<h2 id="3-envelope-layer-reference-expanded">3. Envelope Layer Reference (Expanded)<a class="headerlink" href="#3-envelope-layer-reference-expanded" title="Permanent link">&para;</a></h2>
<p><em>(Each layer acts as a gate in the membrane funnel.)</em></p>
<hr />
<h3 id="31-transport-envelope">3.1 Transport Envelope<a class="headerlink" href="#31-transport-envelope" title="Permanent link">&para;</a></h3>
<p><strong>Summary:</strong> The outermost envelope governing routing, Agreement pinning, and protocol negotiation.</p>
<h4 id="conceptual-purpose">Conceptual Purpose<a class="headerlink" href="#conceptual-purpose" title="Permanent link">&para;</a></h4>
<p>The <strong>TransportEnvelope</strong> establishes the routing and trust context for the capsule. It ensures that the message travels only between agents authorized by the governing Agreement and that both peers agree on the ProtocolSuite governing this exchange.</p>
<h4 id="holon-type-and-relationships">Holon Type and Relationships<a class="headerlink" href="#holon-type-and-relationships" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>HolonType: TransportEnvelope
Relationships:
  Wraps → AuthNEnvelope
  ForAgreement → Agreement
  ProposesSuite → ProtocolSuite?
  AcceptedSuite → ProtocolSuite
  SenderAgent → Agent
  RecipientAgent → Agent
</code></pre></div>
<h4 id="key-data-fields">Key Data Fields<a class="headerlink" href="#key-data-fields" title="Permanent link">&para;</a></h4>
<ul>
<li><code>sender_id</code>: Agent identifier of initiator</li>
<li><code>recipient_id</code>: target Agent identifier</li>
<li><code>agreement_ref</code>: reference to Agreement ID and version hash</li>
<li><code>transport_protocol</code>: protocol to be used (DHT, relay, direct)</li>
<li><code>timestamp</code>: for replay detection</li>
<li><code>routing_signature</code>: optional checksum or route proof</li>
</ul>
<h4 id="processing-steps">Processing Steps<a class="headerlink" href="#processing-steps" title="Permanent link">&para;</a></h4>
<p><strong>Build:</strong>
1. Fetch Agreement metadata; confirm peer is an authorized participant.
2. Select candidate <code>ProtocolSuite</code> and record as <code>ProposesSuite</code>.
3. Compute and store routing metadata and Agreement hash.
4. Attach the next envelope as payload.</p>
<p><strong>Validate:</strong>
1. Verify Agreement hash matches local record.
2. Check recipient field corresponds to the local Agent.
3. Confirm <code>AcceptedSuite</code> belongs to Agreement’s allowed suites.
4. Resolve routing path via Agreement transport settings.</p>
<h4 id="expected-outcome">Expected Outcome<a class="headerlink" href="#expected-outcome" title="Permanent link">&para;</a></h4>
<p>Validated routing context and pinned Agreement; the capsule is confirmed to have arrived at the correct membrane pore under the proper governance framework.</p>
<h4 id="developer-guidance">Developer Guidance<a class="headerlink" href="#developer-guidance" title="Permanent link">&para;</a></h4>
<p>Rust developers should implement this as the first validator in the inbound pipeline. TransportEnvelope validation failures typically indicate misrouting or incompatible Agreements.</p>
<hr />
<h3 id="32-authentication-envelope-authn">3.2 Authentication Envelope (AuthN)<a class="headerlink" href="#32-authentication-envelope-authn" title="Permanent link">&para;</a></h3>
<p><strong>Summary:</strong> Establishes the authenticity and integrity of the capsule.</p>
<h4 id="conceptual-purpose_1">Conceptual Purpose<a class="headerlink" href="#conceptual-purpose_1" title="Permanent link">&para;</a></h4>
<p>The <strong>AuthNEnvelope</strong> confirms that the message was genuinely sent by an authorized participant and that its contents have not been modified since transmission.</p>
<h4 id="holon-type-and-relationships_1">Holon Type and Relationships<a class="headerlink" href="#holon-type-and-relationships_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>HolonType: AuthNEnvelope
Relationships:
  Wraps → CryptoEnvelope
  SignerAgent → Agent
  UsesCryptoPolicy → CryptoPolicy
</code></pre></div>
<h4 id="key-data-fields_1">Key Data Fields<a class="headerlink" href="#key-data-fields_1" title="Permanent link">&para;</a></h4>
<ul>
<li><code>signature_scheme</code>: algorithm identifier (e.g., Ed25519)</li>
<li><code>signature</code>: base64 signature of inner envelope hash</li>
<li><code>signer_public_key_ref</code>: pointer to sender’s public key within Agreement</li>
<li><code>signed_hash</code>: computed SHA-256 or BLAKE3 digest</li>
</ul>
<h4 id="processing-steps_1">Processing Steps<a class="headerlink" href="#processing-steps_1" title="Permanent link">&para;</a></h4>
<p><strong>Build:</strong>
1. Serialize the inner envelope and compute hash.
2. Sign the hash using the sender’s private key via Lair.
3. Attach signature and metadata.</p>
<p><strong>Validate:</strong>
1. Retrieve sender’s public key from Agreement.
2. Recompute hash of the inner envelope.
3. Verify signature using declared algorithm.
4. Log outcome to telemetry for risk analysis.</p>
<h4 id="expected-outcome_1">Expected Outcome<a class="headerlink" href="#expected-outcome_1" title="Permanent link">&para;</a></h4>
<p>Message integrity and sender authenticity confirmed. If verification fails, the capsule is discarded.</p>
<h4 id="developer-guidance_1">Developer Guidance<a class="headerlink" href="#developer-guidance_1" title="Permanent link">&para;</a></h4>
<p>Use the <code>ring</code> or <code>ed25519_dalek</code> crates for signing/verification; keys must always be accessed through Lair interfaces. Avoid holding private keys in process memory longer than necessary.</p>
<hr />
<h3 id="33-cryptography-envelope-crypto">3.3 Cryptography Envelope (Crypto)<a class="headerlink" href="#33-cryptography-envelope-crypto" title="Permanent link">&para;</a></h3>
<p><strong>Summary:</strong> Provides confidentiality by encrypting the inner payload.</p>
<h4 id="conceptual-purpose_2">Conceptual Purpose<a class="headerlink" href="#conceptual-purpose_2" title="Permanent link">&para;</a></h4>
<p>The <strong>CryptoEnvelope</strong> ensures that only the intended recipient can read the inner payload. It also provides tamper protection and payload freshness via nonces.</p>
<h4 id="holon-type-and-relationships_2">Holon Type and Relationships<a class="headerlink" href="#holon-type-and-relationships_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>HolonType: CryptoEnvelope
Relationships:
  Wraps → AuthZEnvelope
  RecipientAgent → Agent
  UsesCryptoPolicy → CryptoPolicy
</code></pre></div>
<h4 id="key-data-fields_2">Key Data Fields<a class="headerlink" href="#key-data-fields_2" title="Permanent link">&para;</a></h4>
<ul>
<li><code>cipher_suite</code>: e.g., XChaCha20-Poly1305</li>
<li><code>nonce</code>: unique per message</li>
<li><code>encrypted_payload</code>: ciphertext of next envelope</li>
<li><code>key_ref</code>: recipient public key or shared secret identifier</li>
</ul>
<h4 id="processing-steps_2">Processing Steps<a class="headerlink" href="#processing-steps_2" title="Permanent link">&para;</a></h4>
<p><strong>Build:</strong>
1. Serialize inner envelope.
2. Generate random nonce.
3. Encrypt payload with recipient’s public key or derived shared secret.
4. Attach cipher suite metadata.</p>
<p><strong>Validate:</strong>
1. Fetch recipient private key from Lair.
2. Decrypt payload using declared cipher suite.
3. Verify authentication tag integrity.
4. Replace ciphertext with plaintext inner envelope.</p>
<h4 id="expected-outcome_2">Expected Outcome<a class="headerlink" href="#expected-outcome_2" title="Permanent link">&para;</a></h4>
<p>Payload decrypted successfully; the next layer is now readable only by authorized recipient.</p>
<h4 id="developer-guidance_2">Developer Guidance<a class="headerlink" href="#developer-guidance_2" title="Permanent link">&para;</a></h4>
<p>Follow the crypto policy declared in Agreement. Ensure nonce uniqueness per sender-recipient-session to prevent replay attacks.</p>
<hr />
<h3 id="34-authorization-envelope-authz">3.4 Authorization Envelope (AuthZ)<a class="headerlink" href="#34-authorization-envelope-authz" title="Permanent link">&para;</a></h3>
<p><strong>Summary:</strong> Enforces role- and scope-based permission checks.</p>
<h4 id="conceptual-purpose_3">Conceptual Purpose<a class="headerlink" href="#conceptual-purpose_3" title="Permanent link">&para;</a></h4>
<p>The <strong>AuthZEnvelope</strong> ensures the request is permitted under the Agreement’s role, scope, and timing rules. It acts as a programmable contract verifying that the sender’s authority matches the Dance being requested.</p>
<h4 id="holon-type-and-relationships_3">Holon Type and Relationships<a class="headerlink" href="#holon-type-and-relationships_3" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>HolonType: AuthZEnvelope
Relationships:
  Wraps → DispatchEnvelope
  ForAgreement → Agreement
  EvaluatedBy → AuthZPolicy
</code></pre></div>
<h4 id="key-data-fields_3">Key Data Fields<a class="headerlink" href="#key-data-fields_3" title="Permanent link">&para;</a></h4>
<ul>
<li><code>role</code>: sender’s role within Agreement</li>
<li><code>scope</code>: access scope or resource domain</li>
<li><code>policy_tag</code>: identifier for specific AuthZPolicy</li>
<li><code>valid_from</code> / <code>valid_until</code>: temporal constraints</li>
<li><code>policy_signature</code>: optional policy binding proof</li>
</ul>
<h4 id="processing-steps_3">Processing Steps<a class="headerlink" href="#processing-steps_3" title="Permanent link">&para;</a></h4>
<p><strong>Build:</strong>
1. Query Agreement for sender’s role and applicable AuthZPolicy.
2. Embed policy tag and validity window.
3. Sign policy tag if required.</p>
<p><strong>Validate:</strong>
1. Fetch AuthZPolicy from Agreement.
2. Evaluate role-scope alignment against requested Dance.
3. Check time window validity.
4. Verify policy signature if provided.</p>
<h4 id="expected-outcome_3">Expected Outcome<a class="headerlink" href="#expected-outcome_3" title="Permanent link">&para;</a></h4>
<p>Authorization confirmed. Capsule can proceed to dispatch. If denied, validation stops with <code>HolonError::UnauthorizedRole</code>.</p>
<h4 id="developer-guidance_3">Developer Guidance<a class="headerlink" href="#developer-guidance_3" title="Permanent link">&para;</a></h4>
<p>The AuthZ layer is where governance logic is enforced. Ensure policies are declarative holons so they can evolve without code changes.</p>
<hr />
<h3 id="35-dispatch-envelope">3.5 Dispatch Envelope<a class="headerlink" href="#35-dispatch-envelope" title="Permanent link">&para;</a></h3>
<p><strong>Summary:</strong> Controls membrane handoff to local execution.</p>
<h4 id="conceptual-purpose_4">Conceptual Purpose<a class="headerlink" href="#conceptual-purpose_4" title="Permanent link">&para;</a></h4>
<p>The <strong>DispatchEnvelope</strong> represents the moment a capsule transitions from inter-Space validation into intra-Space execution. It validates the target I-Space, ensures that the Dance type is known locally, and checks that any declared target matches an available handler.</p>
<h4 id="holon-type-and-relationships_4">Holon Type and Relationships<a class="headerlink" href="#holon-type-and-relationships_4" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>HolonType: DispatchEnvelope
Relationships:
  Wraps → PayloadEnvelope
  TargetSpace → Space
</code></pre></div>
<h4 id="key-data-fields_4">Key Data Fields<a class="headerlink" href="#key-data-fields_4" title="Permanent link">&para;</a></h4>
<ul>
<li><code>target_space</code>: identifier of destination I-Space or subcontext</li>
<li><code>execution_context</code>: optional environment variables</li>
<li><code>dispatch_signature</code>: integrity hash of routing parameters</li>
</ul>
<h4 id="processing-steps_4">Processing Steps<a class="headerlink" href="#processing-steps_4" title="Permanent link">&para;</a></h4>
<p><strong>Build:</strong>
1. Determine target I-Space based on Agreement routing.
2. Compute dispatch hash.
3. Attach as header to envelope.</p>
<p><strong>Validate:</strong>
1. Confirm that <code>target_space</code> matches local identifier.
2. Check that Dance type exists and is callable.
3. Log dispatch acceptance event.</p>
<h4 id="expected-outcome_4">Expected Outcome<a class="headerlink" href="#expected-outcome_4" title="Permanent link">&para;</a></h4>
<p>Local execution context prepared; control passed to Choreographer.</p>
<h4 id="developer-guidance_4">Developer Guidance<a class="headerlink" href="#developer-guidance_4" title="Permanent link">&para;</a></h4>
<p>Implement DispatchEnvelope validation as the final gate before local code execution. Validation failures should never trigger automatic retries.</p>
<hr />
<h3 id="36-payload-envelope">3.6 Payload Envelope<a class="headerlink" href="#36-payload-envelope" title="Permanent link">&para;</a></h3>
<p><strong>Summary:</strong> Contains the actual DanceRequest or DanceResponse.</p>
<h4 id="conceptual-purpose_5">Conceptual Purpose<a class="headerlink" href="#conceptual-purpose_5" title="Permanent link">&para;</a></h4>
<p>The <strong>PayloadEnvelope</strong> is the innermost layer, containing the semantic content of the interaction. At this point all membrane gates have been cleared.</p>
<h4 id="holon-type-and-relationships_5">Holon Type and Relationships<a class="headerlink" href="#holon-type-and-relationships_5" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>HolonType: PayloadEnvelope
Relationships:
  HasPayloadDance → Dance
</code></pre></div>
<h4 id="key-data-fields_5">Key Data Fields<a class="headerlink" href="#key-data-fields_5" title="Permanent link">&para;</a></h4>
<ul>
<li><code>payload_type</code>: Request or Response</li>
<li><code>payload_model</code>: descriptor name</li>
<li><code>payload_digest</code>: hash for integrity</li>
<li><code>content_encoding</code>: optional compression scheme</li>
</ul>
<h4 id="processing-steps_5">Processing Steps<a class="headerlink" href="#processing-steps_5" title="Permanent link">&para;</a></h4>
<p><strong>Build:</strong>
1. Serialize Dance into canonical format.
2. Compute payload hash.
3. Embed descriptor metadata.</p>
<p><strong>Validate:</strong>
1. Verify hash matches payload content.
2. Deserialize Dance into model.
3. Pass to Choreographer.</p>
<h4 id="expected-outcome_5">Expected Outcome<a class="headerlink" href="#expected-outcome_5" title="Permanent link">&para;</a></h4>
<p>Validated and deserialized Dance ready for execution.</p>
<h4 id="developer-guidance_5">Developer Guidance<a class="headerlink" href="#developer-guidance_5" title="Permanent link">&para;</a></h4>
<p>This envelope rarely fails validation except for integrity mismatches. Any schema errors should be handled by the Choreographer.</p>
<hr />
<h3 id="37-exfiltration-envelope-outbound">3.7 Exfiltration Envelope (Outbound)<a class="headerlink" href="#37-exfiltration-envelope-outbound" title="Permanent link">&para;</a></h3>
<p><strong>Summary:</strong> Filters outbound data per Agreement’s ExfiltrationPolicy.</p>
<h4 id="conceptual-purpose_6">Conceptual Purpose<a class="headerlink" href="#conceptual-purpose_6" title="Permanent link">&para;</a></h4>
<p>The <strong>ExfiltrationEnvelope</strong> ensures that responses leaving a Space comply with that Space’s data sharing rules. It enforces outbound privacy and ensures that only agreed-upon data crosses the membrane.</p>
<h4 id="holon-type-and-relationships_6">Holon Type and Relationships<a class="headerlink" href="#holon-type-and-relationships_6" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>HolonType: ExfiltrationEnvelope
Relationships:
  Wraps → CryptoEnvelope
  AppliesPolicy → ExfiltrationPolicy
</code></pre></div>
<h4 id="key-data-fields_6">Key Data Fields<a class="headerlink" href="#key-data-fields_6" title="Permanent link">&para;</a></h4>
<ul>
<li><code>policy_tag</code>: identifier of applied ExfiltrationPolicy</li>
<li><code>allowed_fields</code>: whitelist of fields</li>
<li><code>thresholds</code>: quantitative limits (e.g., max records)</li>
<li><code>sanitization_map</code>: redaction rules</li>
</ul>
<h4 id="processing-steps_6">Processing Steps<a class="headerlink" href="#processing-steps_6" title="Permanent link">&para;</a></h4>
<p><strong>Build:</strong>
1. Retrieve ExfiltrationPolicy from Agreement.
2. Filter or redact prohibited fields.
3. Record policy tag and transformation metadata.</p>
<p><strong>Validate:</strong>
1. Confirm policy tag exists and matches Agreement.
2. Verify filtered payload complies with declared thresholds.
3. Hash sanitized payload for audit.</p>
<h4 id="expected-outcome_6">Expected Outcome<a class="headerlink" href="#expected-outcome_6" title="Permanent link">&para;</a></h4>
<p>Outbound data sanitized, ready for encryption.</p>
<h4 id="developer-guidance_6">Developer Guidance<a class="headerlink" href="#developer-guidance_6" title="Permanent link">&para;</a></h4>
<p>Developers must implement serialization filters at this layer. Avoid policy logic in business code; always reference ExfiltrationPolicy holons.</p>
<hr />
<h3 id="38-unlock-envelope-optional">3.8 Unlock Envelope (Optional)<a class="headerlink" href="#38-unlock-envelope-optional" title="Permanent link">&para;</a></h3>
<p><strong>Summary:</strong> Captures Second-Factor Session (SFS) verification for sensitive Dances.</p>
<h4 id="conceptual-purpose_7">Conceptual Purpose<a class="headerlink" href="#conceptual-purpose_7" title="Permanent link">&para;</a></h4>
<p>The <strong>UnlockEnvelope</strong> adds human-level verification to the cryptographic stack. It confirms that the user controlling the device has recently authenticated through a configured second factor before performing sensitive or high-risk operations.</p>
<h4 id="holon-type-and-relationships_7">Holon Type and Relationships<a class="headerlink" href="#holon-type-and-relationships_7" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>HolonType: UnlockEnvelope
Relationships:
  Wraps → NextEnvelope
  VerifiedBy → StepUpPolicy
  SessionBelongsTo → Agent
</code></pre></div>
<h4 id="key-data-fields_7">Key Data Fields<a class="headerlink" href="#key-data-fields_7" title="Permanent link">&para;</a></h4>
<ul>
<li><code>session_id</code>: UUID of SFS</li>
<li><code>verified_method</code>: biometric | PIN | hardware_key</li>
<li><code>expires_at</code>: timestamp</li>
<li><code>issued_at</code>: timestamp</li>
</ul>
<h4 id="processing-steps_7">Processing Steps<a class="headerlink" href="#processing-steps_7" title="Permanent link">&para;</a></h4>
<p><strong>Build:</strong>
1. Verify an active SFS exists for this Agent.
2. Record method and expiry.
3. Link to StepUpPolicy.</p>
<p><strong>Validate:</strong>
1. Fetch SFS from secure store.
2. Check TTL and idle timeout.
3. Confirm cryptographic binding to Agent ID.</p>
<h4 id="expected-outcome_7">Expected Outcome<a class="headerlink" href="#expected-outcome_7" title="Permanent link">&para;</a></h4>
<p>Step-up authentication confirmed; the Dance may proceed.</p>
<h4 id="developer-guidance_7">Developer Guidance<a class="headerlink" href="#developer-guidance_7" title="Permanent link">&para;</a></h4>
<p>UnlockEnvelope creation and validation should integrate with the device OS authentication APIs. Never store SFS secrets in application memory.</p>
<hr />
<h3 id="39-sessionstate-envelope-optional">3.9 SessionState Envelope (Optional)<a class="headerlink" href="#39-sessionstate-envelope-optional" title="Permanent link">&para;</a></h3>
<p><strong>Summary:</strong> Transports transient holon state for stateless executions.</p>
<h4 id="conceptual-purpose_8">Conceptual Purpose<a class="headerlink" href="#conceptual-purpose_8" title="Permanent link">&para;</a></h4>
<p>The <strong>SessionStateEnvelope</strong> allows stateful workflows to execute in stateless environments by serializing necessary transient holons and relationship references. It ensures the guest process has enough context to continue processing without permanent data leakage.</p>
<h4 id="holon-type-and-relationships_8">Holon Type and Relationships<a class="headerlink" href="#holon-type-and-relationships_8" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>HolonType: SessionStateEnvelope
Relationships:
  Wraps → PayloadEnvelope
  CarriesState → [TransientHolonPool, NurseryRefs]
</code></pre></div>
<h4 id="key-data-fields_8">Key Data Fields<a class="headerlink" href="#key-data-fields_8" title="Permanent link">&para;</a></h4>
<ul>
<li><code>state_hash</code>: integrity checksum</li>
<li><code>state_length</code>: size in bytes</li>
<li><code>allowed_types</code>: whitelist of permitted transient types</li>
</ul>
<h4 id="processing-steps_8">Processing Steps<a class="headerlink" href="#processing-steps_8" title="Permanent link">&para;</a></h4>
<p><strong>Build:</strong>
1. Serialize transient pool and nursery references.
2. Compute hash and record metadata.
3. Attach to next envelope.</p>
<p><strong>Validate:</strong>
1. Verify hash integrity.
2. Deserialize transient pool.
3. Enforce allowed_types filter.</p>
<h4 id="expected-outcome_8">Expected Outcome<a class="headerlink" href="#expected-outcome_8" title="Permanent link">&para;</a></h4>
<p>State hydrated in recipient’s transient context; execution can proceed seamlessly.</p>
<h4 id="developer-guidance_8">Developer Guidance<a class="headerlink" href="#developer-guidance_8" title="Permanent link">&para;</a></h4>
<p>Keep transient pools small. This mechanism is not intended for bulk data transfer. Always validate deserialized objects before use.</p>
<hr />
<h2 id="4-lifecycle-overview">4. Lifecycle Overview<a class="headerlink" href="#4-lifecycle-overview" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>Outbound Request:</strong> Select suite, negotiate, build, transmit.</li>
<li><strong>Inbound Validation:</strong> Validate sequentially (Transport→AuthN→Crypto→AuthZ→Dispatch→Payload).</li>
<li><strong>Response:</strong> Apply outbound envelopes in reverse order and send back.</li>
</ol>
<hr />
<h2 id="5-error-handling">5. Error Handling<a class="headerlink" href="#5-error-handling" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>Error</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>InvalidAgreementRef</code></td>
<td>Agreement hash mismatch.</td>
</tr>
<tr>
<td><code>ProtocolSuiteMismatch</code></td>
<td>Suite not permitted.</td>
</tr>
<tr>
<td><code>InvalidProtocolProposal</code></td>
<td>Proposed suite invalid.</td>
</tr>
<tr>
<td><code>SuiteDownshiftNotPermitted</code></td>
<td>Unauthorized fallback.</td>
</tr>
<tr>
<td><code>SignatureInvalid</code></td>
<td>AuthN failure.</td>
</tr>
<tr>
<td><code>DecryptionFailed</code></td>
<td>Crypto validation failed.</td>
</tr>
<tr>
<td><code>UnauthorizedRole</code></td>
<td>AuthZ check failed.</td>
</tr>
<tr>
<td><code>DispatchDenied</code></td>
<td>Target invalid.</td>
</tr>
<tr>
<td><code>ExfiltrationDenied</code></td>
<td>Policy violation.</td>
</tr>
<tr>
<td><code>RequiresSecondFactor</code></td>
<td>Missing SFS.</td>
</tr>
<tr>
<td><code>SessionStateUnavailable</code></td>
<td>Missing transient data.</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="6-implementation-notes">6. Implementation Notes<a class="headerlink" href="#6-implementation-notes" title="Permanent link">&para;</a></h2>
<ul>
<li>All envelopes and policies are holons declared in the Meta-Schema.</li>
<li>Validators and builders are modular and referenced dynamically via descriptors.</li>
<li>Use Lair for all key operations; private keys never exposed.</li>
<li>Emit telemetry for every validation result to support audit and behavioral analysis.</li>
<li>Agreements may define multiple suites per sensitivity tier for flexible negotiation.</li>
</ul>
<h3 id="61-packaging-and-dependency-isolation">6.1 Packaging and Dependency Isolation<a class="headerlink" href="#61-packaging-and-dependency-isolation" title="Permanent link">&para;</a></h3>
<p>Protocol-specific dependencies—such as Holochain’s <code>hdk</code>—are confined to <strong>adapter crates</strong>.<br />
The Trust Channel and Capsule Dancer remain pure Rust libraries, enabling protocol pluggability and independent evolution.</p>
<p><strong>Recommended Crate Layout</strong>
<div class="highlight"><pre><span></span><code>map_core/                ← holons, agreements, policies
map_trust_channel/       ← DanceInitiator, CapsuleDancer, TrustChannel
map_holochain_adapter/   ← Holochain externs (depends on `hdk`)
map_wire_adapter/        ← future direct P2P adapter
map_http_adapter/        ← future relay / gateway adapter
</code></pre></div></p>
<p><strong>Key Principles</strong>
- Core and trust-channel crates contain no direct dependency on <code>hdk</code> or any host framework.
- Each adapter crate provides its own membrane interface (e.g., <code>#[hdk_extern] fn dance_capsule</code>) and delegates to the same <code>CapsuleDancer</code> implementation.
- This encapsulation enables testing and reuse of the Trust Channel in multiple environments and ensures that only the outermost adapter layer needs updating when a transport changes.</p>
<hr />
<h2 id="7-summary">7. Summary<a class="headerlink" href="#7-summary" title="Permanent link">&para;</a></h2>
<p>The Trust Channel provides a <strong>layered, Agreement-driven security framework</strong> for all cross-Space communications.<br />
Each envelope serves a distinct purpose, from routing and authentication to encryption, authorization, dispatch, and outbound filtering.<br />
Protocol negotiation guarantees interoperability, while each validation gate enforces sovereignty and trust.<br />
This layered architecture transforms MAP’s peer-to-peer network into a <strong>self-verifying, self-governing fabric</strong> for secure inter-Space collaboration.</p>
<h3 id="appendix-a-unified-ingress-egress-summary">Appendix A — Unified Ingress / Egress Summary<a class="headerlink" href="#appendix-a-unified-ingress-egress-summary" title="Permanent link">&para;</a></h3>
<p><strong>Unified Capsule Flow</strong></p>
<div class="highlight"><pre><span></span><code>Protocol Adapter  →  CapsuleDancer::dance_capsule()
                         ↓
                     TrustChannel
               (unwrap → validate → dispatch)
                         ↓
                        Dancer
               (executes the Dance logic)
                         ↓
                     TrustChannel
               (wrap → encrypt → sign)
                         ↓
                CapsuleDancer::dance_capsule()
                         ↓
                 Protocol Adapter (reply)
</code></pre></div>
<p><strong>Benefits</strong>
- <strong>Single ingress/egress interface:</strong> All protocols converge on <code>CapsuleDancer::dance_capsule</code>.
- <strong>Security consistency:</strong> Every request and response passes through the same validation gates.
- <strong>Isolation of dependencies:</strong> Framework bindings remain in adapter crates only.
- <strong>Extensibility:</strong> New protocols can be added without altering Trust Channel logic.
- <strong>Narrative clarity:</strong> Code reads naturally—initiators initiate, dancers dance, and capsules are danced through the Trust Channel.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "search.highlight", "navigation.top", "navigation.footer", "content.action.edit"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>